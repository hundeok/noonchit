import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../core/di/market_mood_provider.dart';

/// Market Mood ÏÉÅÏÑ∏ Ï†ïÎ≥¥ ÌåùÏóÖ Ïò§Î≤ÑÎ†àÏù¥
class MarketMoodStatsOverlay {
  static OverlayEntry? _overlayEntry;

  /// Î°±ÌîÑÎ†àÏä§ Ïãú ÌåùÏóÖ ÌëúÏãú
  static void show({
    required BuildContext context,
    required WidgetRef ref,
    required Offset position,
    required double statusIconSize,
    required MarketMoodData data,
  }) {
    hide(); // Í∏∞Ï°¥ ÌåùÏóÖ Ï†úÍ±∞

    _overlayEntry = OverlayEntry(
      builder: (context) => _MarketMoodStatsPopup(
        position: position,
        statusIconSize: statusIconSize,
        ref: ref,
        data: data,
      ),
    );

    Overlay.of(context).insert(_overlayEntry!);
  }

  /// ÌåùÏóÖ Ïà®Í∏∞Í∏∞
  static void hide() {
    _overlayEntry?.remove();
    _overlayEntry = null;
  }
}

class _MarketMoodStatsPopup extends StatefulWidget {
  final Offset position;
  final double statusIconSize;
  final WidgetRef ref;
  final MarketMoodData data;

  const _MarketMoodStatsPopup({
    required this.position,
    required this.statusIconSize,
    required this.ref,
    required this.data,
  });

  @override
  State<_MarketMoodStatsPopup> createState() => _MarketMoodStatsPopupState();
}

class _MarketMoodStatsPopupState extends State<_MarketMoodStatsPopup>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _scaleAnimation;
  late Animation<double> _opacityAnimation;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      duration: const Duration(milliseconds: 200),
      vsync: this,
    );

    _scaleAnimation = Tween<double>(
      begin: 0.0,
      end: 1.0,
    ).animate(CurvedAnimation(
      parent: _controller,
      curve: Curves.elasticOut,
    ));

    _opacityAnimation = Tween<double>(
      begin: 0.0,
      end: 1.0,
    ).animate(CurvedAnimation(
      parent: _controller,
      curve: const Interval(0.0, 0.5),
    ));

    _controller.forward();
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTap: () => MarketMoodStatsOverlay.hide(),
      behavior: HitTestBehavior.translucent,
      child: Material(
        color: Colors.transparent,
        child: Stack(
          children: [
            // Ìà¨Î™Ö Î∞∞Í≤Ω (ÌÉ≠ÌïòÎ©¥ Îã´Ìûò)
            Positioned.fill(
              child: Container(color: Colors.transparent),
            ),
            // Ïã§Ï†ú ÌåùÏóÖ
            AnimatedBuilder(
              animation: _controller,
              builder: (context, child) {
                return Positioned(
                  left: widget.position.dx,
                  top: widget.position.dy,
                  child: Transform.scale(
                    scale: _scaleAnimation.value,
                    alignment: Alignment.center,
                    child: Opacity(
                      opacity: _opacityAnimation.value,
                      child: _buildPopupContent(),
                    ),
                  ),
                );
              },
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildPopupContent() {
    // ÌôîÎ©¥ ÌÅ¨Í∏∞ Í∞ÄÏ†∏Ïò§Í∏∞ (ÏÉàÎ°úÏö¥ 2ÏÑπÏÖò ÏãúÏä§ÌÖú ÎåÄÏùë)
    final screenSize = MediaQuery.of(context).size;
    final maxWidth = screenSize.width * 0.95; // 95%Î°ú ÌôïÏû•

    return IntrinsicWidth(
      child: Container(
        constraints: BoxConstraints(
          minWidth: widget.statusIconSize * 4.2,
          maxWidth: maxWidth,
        ),
        decoration: BoxDecoration(
          color: Theme.of(context).colorScheme.surface,
          borderRadius: BorderRadius.circular(16),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withValues(alpha: 0.08),
              blurRadius: 16,
              offset: const Offset(0, 6),
              spreadRadius: 2,
            ),
            BoxShadow(
              color: Colors.black.withValues(alpha: 0.04),
              blurRadius: 4,
              offset: const Offset(0, 2),
            ),
          ],
          border: Border.all(
            color: Theme.of(context).colorScheme.outline.withValues(alpha: 0.12),
            width: 0.8,
          ),
        ),
        child: Padding(
          padding: const EdgeInsets.all(14),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              // Î©îÏù∏ Ìó§Îçî
              _buildHeader(),
              const SizedBox(height: 8),
              // ÌïµÏã¨ ÏßÄÌëú
              _buildCoreMetrics(),
              const SizedBox(height: 8),
              // üöÄ Section 1: ÌÉÄÏûÑÌîÑÎ†àÏûÑÎ≥Ñ Í∞ÄÏÜçÎèÑ Î∂ÑÏÑù (ÏÉàÎ°úÏö¥ ÏãúÏä§ÌÖú)
              _buildSection1TimeframeComparison(),
              const SizedBox(height: 8),
              // üìÖ Section 2: Îç∞ÏùºÎ¶¨ Í±∞Îûò ÌòÑÌô©
              _buildSection2DailyStatus(),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildHeader() {
    final data = widget.data;
    final currentMood = widget.ref.watch(currentMarketMoodProvider);
    final updateTime = _formatUpdateTime(data.updatedAt);

    // Î∂ÑÏúÑÍ∏∞ Ïù¥Î™®ÏßÄ Îß§Ìïë
    String moodEmoji = switch (currentMood) {
      MarketMood.bull => 'üöÄ',
      MarketMood.weakBull => 'üî•',
      MarketMood.sideways => '‚öñÔ∏è',
      MarketMood.bear => 'üíß',
      MarketMood.deepBear => 'üßä',
    };

    String moodName = switch (currentMood) {
      MarketMood.bull => 'Î∂àÏû•',
      MarketMood.weakBull => 'ÏïΩÎ∂àÏû•',
      MarketMood.sideways => 'Ï§ëÍ∞ÑÏû•',
      MarketMood.bear => 'Î¨ºÏû•',
      MarketMood.deepBear => 'ÏñºÏùåÏû•',
    };

    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        // Î©îÏù∏ ÌÉÄÏù¥ÌãÄ (30Î∂Ñ Í∏∞Ï§Ä Í∞ÄÏÜçÎèÑ Î∂ÑÏÑù)
        Row(
          mainAxisSize: MainAxisSize.min,
          children: [
            Text(
              moodEmoji,
              style: const TextStyle(fontSize: 12),
            ),
            const SizedBox(width: 4),
            Flexible(
              child: Text(
                '$moodName - 30Î∂Ñ Í∞ÄÏÜçÎèÑ Î∂ÑÏÑù',
                style: TextStyle(
                  fontSize: 11,
                  fontWeight: FontWeight.w700,
                  color: Theme.of(context).colorScheme.onSurface,
                  letterSpacing: 0.3,
                ),
                overflow: TextOverflow.ellipsis,
              ),
            ),
          ],
        ),
        const SizedBox(height: 2),
        // 15Î∂Ñ ÏóÖÎç∞Ïù¥Ìä∏ Ï£ºÍ∏∞ ÏïàÎÇ¥
        Row(
          mainAxisSize: MainAxisSize.min,
          children: [
            Icon(
              Icons.sync,
              size: 9,
              color: Theme.of(context).colorScheme.primary.withValues(alpha: 0.7),
            ),
            const SizedBox(width: 3),
            Text(
              '15Î∂ÑÎßàÎã§ ÏóÖÎç∞Ïù¥Ìä∏ ‚Ä¢ ',
              style: TextStyle(
                fontSize: 8,
                fontWeight: FontWeight.w500,
                color: Theme.of(context).colorScheme.primary.withValues(alpha: 0.7),
              ),
            ),
            Icon(
              Icons.access_time,
              size: 9,
              color: Theme.of(context).colorScheme.onSurface.withValues(alpha: 0.6),
            ),
            const SizedBox(width: 3),
            Flexible(
              child: Text(
                '$updateTime Í∞±Ïã†',
                style: TextStyle(
                  fontSize: 8,
                  color: Theme.of(context).colorScheme.onSurface.withValues(alpha: 0.6),
                ),
                overflow: TextOverflow.ellipsis,
              ),
            ),
          ],
        ),
      ],
    );
  }

  Widget _buildCoreMetrics() {
    final data = widget.data;

    return Column(
      mainAxisSize: MainAxisSize.min,
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        _buildSectionTitle('ÌïµÏã¨ ÏßÄÌëú', Icons.analytics),
        const SizedBox(height: 4),
        _buildStatRow(
          icon: Icons.monetization_on,
          label: '24ÏãúÍ∞Ñ Í±∞ÎûòÎåÄÍ∏à',
          value: MarketMoodCalculator.formatVolume(data.totalVolumeUsd),
          isHighlight: true,
        ),
        _buildStatRow(
          icon: Icons.pie_chart,
          label: 'Ï¥ù ÏãúÍ∞ÄÏ¥ùÏï°',
          value: _formatMarketCap(data.totalMarketCapUsd),
        ),
        _buildStatRow(
          icon: Icons.trending_up,
          label: 'ÏãúÏ¥ù 24ÏãúÍ∞Ñ Î≥ÄÌôî',
          value: '${data.marketCapChange24h >= 0 ? '+' : ''}${data.marketCapChange24h.toStringAsFixed(2)}%',
          isHighlight: data.marketCapChange24h > 0,
          isWarning: data.marketCapChange24h < -2,
        ),
        _buildStatRow(
          icon: Icons.flash_on,
          label: 'BTC ÎèÑÎØ∏ÎÑåÏä§',
          value: '${data.btcDominance.toStringAsFixed(1)}%',
        ),
      ],
    );
  }

  /// üöÄ Section 1: ÌÉÄÏûÑÌîÑÎ†àÏûÑÎ≥Ñ Í∞ÄÏÜçÎèÑ Î∂ÑÏÑù (ÏôÑÏ†Ñ ÏÉàÎ°úÏö¥ ÏãúÏä§ÌÖú)
  Widget _buildSection1TimeframeComparison() {
    return Consumer(
      builder: (context, ref, child) {
        final comparisonData = ref.watch(timeframeComparisonProvider);
        final slotManager = ref.read(ultimateSlotCacheManagerProvider);
        
        return Column(
          mainAxisSize: MainAxisSize.min,
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            _buildSectionTitle('ÌÉÄÏûÑÌîÑÎ†àÏûÑÎ≥Ñ Í∞ÄÏÜçÎèÑ Î∂ÑÏÑù', Icons.speed),
            const SizedBox(height: 4),
            
            // Ïù∏Ìä∏ÎùºÎç∞Ïù¥ (6Í∞ú) - ÏÉàÎ°úÏö¥ UI ÏãúÏä§ÌÖú
            _buildSubSectionTitle('Ïù∏Ìä∏ÎùºÎç∞Ïù¥ (ÏôÑÏÑ±Îêú Ïä¨Î°Ø Í∏∞Î∞ò)'),
            _buildNewComparisonRow('30min', comparisonData.thirtyMin, slotManager, Icons.schedule),
            _buildNewComparisonRow('1hour', comparisonData.oneHour, slotManager, Icons.access_time),
            _buildNewComparisonRow('2hour', comparisonData.twoHour, slotManager, Icons.timer),
            _buildNewComparisonRow('4hour', comparisonData.fourHour, slotManager, Icons.timer_3),
            _buildNewComparisonRow('8hour', comparisonData.eightHour, slotManager, Icons.timer_outlined),
            _buildNewComparisonRow('12hour', comparisonData.twelveHour, slotManager, Icons.access_time_filled),
            
            const SizedBox(height: 4),
            
            // Ïû•Í∏∞ (3Í∞ú)
            _buildSubSectionTitle('Ïû•Í∏∞ (ÏùºÎ≥Ñ ÏôÑÏÑ± Îç∞Ïù¥ÌÑ∞ Í∏∞Î∞ò)'),
            _buildNewComparisonRow('1day', comparisonData.oneDay, slotManager, Icons.calendar_today),
            _buildNewComparisonRow('3day', comparisonData.threeDay, slotManager, Icons.view_day),
            _buildNewComparisonRow('1week', comparisonData.oneWeek, slotManager, Icons.date_range),
          ],
        );
      },
    );
  }

  /// üéÆ ÏÉàÎ°úÏö¥ ÎπÑÍµê Ìñâ ÏúÑÏ†Ø (Ï¢åÏ∏°: ÏÉÅÌÉú / Ïö∞Ï∏°: Í≤∞Í≥º)
  Widget _buildNewComparisonRow(String timeframe, ComparisonResult result, UltimateSlotCacheManager slotManager, IconData icon) {
    final gaugeState = slotManager.getGaugeState(timeframe);
    final latestResult = slotManager.getLatestResult(timeframe);
    
    // Ï¢åÏ∏° ÌÖçÏä§Ìä∏ ÏÉùÏÑ±
    final leftText = MarketMoodCalculator.getLeftText(timeframe, result, gaugeState);
    
    // Ïö∞Ï∏° ÌÖçÏä§Ìä∏ ÏÉùÏÑ±
    final rightText = MarketMoodCalculator.getRightText(latestResult);
    
    return Container(
      margin: const EdgeInsets.symmetric(vertical: 1),
      padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 4),
      decoration: BoxDecoration(
        color: gaugeState.isCompleted || gaugeState.isInGracePeriod
            ? Colors.green.withValues(alpha: 0.05)
            : Colors.transparent,
        borderRadius: BorderRadius.circular(6),
      ),
      child: Column(
        children: [
          // ÏÉÅÎã®: Ï¢åÏ∏° ÏÉÅÌÉú + Ïö∞Ï∏° Í≤∞Í≥º
          Row(
            children: [
              // Ï¢åÏ∏°: ÌòÑÏû¨ ÏÉÅÌÉú
              Expanded(
                flex: 3,
                child: Row(
                  children: [
                    Icon(
                      icon,
                      size: 11,
                      color: Theme.of(context).colorScheme.onSurface.withValues(alpha: 0.6),
                    ),
                    const SizedBox(width: 5),
                    Expanded(
                      child: Text(
                        leftText,
                        style: TextStyle(
                          fontSize: 9,
                          fontWeight: FontWeight.w500,
                          color: Theme.of(context).colorScheme.onSurface.withValues(alpha: 0.7),
                        ),
                        overflow: TextOverflow.ellipsis,
                      ),
                    ),
                  ],
                ),
              ),
              // Ïö∞Ï∏°: ÏµúÏã† Í≤∞Í≥º
              SizedBox(
                width: 80,
                child: Text(
                  rightText,
                  style: TextStyle(
                    fontSize: 9,
                    fontWeight: FontWeight.w600,
                    color: _getResultColor(latestResult),
                  ),
                  textAlign: TextAlign.end,
                  overflow: TextOverflow.ellipsis,
                ),
              ),
            ],
          ),
          const SizedBox(height: 3),
          // ÌïòÎã®: Í≤åÏù¥ÏßÄ Î∞î (Ï†ïÎ∞ÄÎèÑ + ÏÉâÏÉÅ Î≥ÄÌôî)
          LinearProgressIndicator(
            value: gaugeState.progress / 100.0,
            backgroundColor: Theme.of(context).colorScheme.outline.withValues(alpha: 0.2),
            valueColor: AlwaysStoppedAnimation(gaugeState.gaugeColor),
            minHeight: 3,
          ),
        ],
      ),
    );
  }

  /// Í≤∞Í≥ºÍ∞íÏóê Îî∞Î•∏ ÏÉâÏÉÅ Í≤∞Ï†ï
  Color _getResultColor(double? changePercent) {
    if (changePercent == null) {
      return Theme.of(context).colorScheme.onSurface.withValues(alpha: 0.4);
    }
    
    if (changePercent > 5) return Colors.green;
    if (changePercent < -5) return Colors.red;
    return Theme.of(context).colorScheme.onSurface.withValues(alpha: 0.6);
  }

  /// üìÖ Section 2: Îç∞ÏùºÎ¶¨ Í±∞Îûò ÌòÑÌô©
  Widget _buildSection2DailyStatus() {
    return Consumer(
      builder: (context, ref, child) {
        final dailyStatus = ref.watch(dailyStatusProvider);
        final now = DateTime.now();
        final currentTime = '${now.hour.toString().padLeft(2, '0')}:${now.minute.toString().padLeft(2, '0')}';
        
        return Column(
          mainAxisSize: MainAxisSize.min,
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            _buildSectionTitle('Îç∞ÏùºÎ¶¨ Í±∞Îûò ÌòÑÌô© ($currentTime Í∏∞Ï§Ä)', Icons.today),
            const SizedBox(height: 4),
            
            // ÏãúÍ∞ÑÎåÄÎ≥Ñ Í∞ïÎèÑ
            if (dailyStatus.hourlyIntensityChange != null)
              _buildStatRow(
                icon: Icons.speed,
                label: 'ÏãúÍ∞ÑÎåÄÎ≥Ñ Í∞ïÎèÑ (Ïñ¥Ï†ú ÎèôÏãúÍ∞Ñ ÎåÄÎπÑ)',
                value: '${dailyStatus.hourlyIntensityChange! >= 0 ? '+' : ''}${dailyStatus.hourlyIntensityChange!.toStringAsFixed(1)}% ${dailyStatus.hourlyIntensityChange! > 5 ? 'ÌôúÎ∞ú ‚ÜóÔ∏è' : dailyStatus.hourlyIntensityChange! < -5 ? 'ÎëîÌôî ‚ÜòÔ∏è' : 'Î≥¥ÌÜµ ‚û°Ô∏è'}',
                isHighlight: dailyStatus.hourlyIntensityChange! > 5,
                isWarning: dailyStatus.hourlyIntensityChange! < -5,
              )
            else
              _buildStatRow(
                icon: Icons.speed,
                label: 'ÏãúÍ∞ÑÎåÄÎ≥Ñ Í∞ïÎèÑ',
                value: '15Î∂Ñ ÌõÑ ÏóÖÎç∞Ïù¥Ìä∏...',
              ),
            
            // ÎàÑÏ†ÅÎ•†
            if (dailyStatus.accumulationRate != null)
              _buildAccumulationDisplay(dailyStatus.accumulationRate!)
            else
              _buildStatRow(
                icon: Icons.trending_up,
                label: 'Ïñ¥Ï†ú ÎåÄÎπÑ ÎàÑÏ†ÅÎ•†',
                value: '15Î∂Ñ ÌõÑ ÏóÖÎç∞Ïù¥Ìä∏...',
              ),
            
            // ÏòàÏÉÅ ÏµúÏ¢ÖÎüâ
            if (dailyStatus.estimatedFinal != null && dailyStatus.yesterdayFinal != null)
              _buildStatRow(
                icon: Icons.psychology,
                label: 'ÏòàÏÉÅ ÏµúÏ¢ÖÎüâ (ÌòÑÏû¨ ÌéòÏù¥Ïä§)',
                value: '${MarketMoodCalculator.formatVolume(dailyStatus.estimatedFinal!)} (${((dailyStatus.estimatedFinal! - dailyStatus.yesterdayFinal!) / dailyStatus.yesterdayFinal! * 100).toStringAsFixed(1)}% ÏòàÏÉÅ)',
                isHighlight: dailyStatus.estimatedFinal! > dailyStatus.yesterdayFinal!,
                isWarning: dailyStatus.estimatedFinal! < dailyStatus.yesterdayFinal! * 0.9,
              ),
          ],
        );
      },
    );
  }

  /// ÎàÑÏ†ÅÎ•† ÌäπÎ≥Ñ ÌëúÏãú (100% Ï¥àÍ≥º Í∞ÄÎä•)
  Widget _buildAccumulationDisplay(double rate) {
    final isOver100 = rate >= 100;
    final displayRate = rate.toStringAsFixed(1);
    
    String statusText;
    if (rate >= 120) {
      statusText = 'üöÄ Ïñ¥Ï†ú Ï¥ùÎüâ ÎåÄÌè≠ Ï¥àÍ≥º!';
    } else if (rate >= 110) {
      statusText = 'üéâ Ïñ¥Ï†ú Ï¥ùÎüâ ÌÅ¨Í≤å Ï¥àÍ≥º!';
    } else if (rate >= 100) {
      statusText = '‚úÖ Ïñ¥Ï†ú Ï¥ùÎüâ Îã¨ÏÑ±!';
    } else if (rate >= 95) {
      statusText = 'üî• Ïñ¥Ï†ú ÏàòÏ§Ä Í∑ºÏ†ë!';
    } else if (rate >= 80) {
      statusText = 'üìà Ïñ¥Ï†úÏùò ÎåÄÎ∂ÄÎ∂Ñ Îã¨ÏÑ±';
    } else {
      statusText = 'ÏßÑÌñâ Ï§ë';
    }
    
    return _buildStatRow(
      icon: isOver100 ? Icons.celebration : Icons.trending_up,
      label: 'Ïñ¥Ï†ú ÎåÄÎπÑ ÎàÑÏ†ÅÎ•†',
      value: '$displayRate% ($statusText)',
      isHighlight: isOver100,
      isWarning: rate < 80,
    );
  }

  Widget _buildSectionTitle(String title, IconData icon) {
    return Row(
      mainAxisSize: MainAxisSize.min,
      children: [
        Icon(
          icon,
          size: 11,
          color: Theme.of(context).colorScheme.primary.withValues(alpha: 0.8),
        ),
        const SizedBox(width: 4),
        Text(
          title,
          style: TextStyle(
            fontSize: 9,
            fontWeight: FontWeight.w700,
            color: Theme.of(context).colorScheme.primary.withValues(alpha: 0.8),
            letterSpacing: 0.3,
          ),
        ),
      ],
    );
  }

  Widget _buildSubSectionTitle(String title) {
    return Padding(
      padding: const EdgeInsets.only(left: 12, bottom: 2),
      child: Text(
        title,
        style: TextStyle(
          fontSize: 8,
          fontWeight: FontWeight.w600,
          color: Theme.of(context).colorScheme.onSurface.withValues(alpha: 0.6),
          letterSpacing: 0.2,
        ),
      ),
    );
  }

  Widget _buildStatRow({
    required IconData icon,
    required String label,
    required String value,
    bool isError = false,
    bool isHighlight = false,
    bool isWarning = false,
  }) {
    Color getColor() {
      if (isError) return Theme.of(context).colorScheme.error;
      if (isHighlight) return Colors.green;
      if (isWarning) return Colors.red;
      return Theme.of(context).colorScheme.onSurface.withValues(alpha: 0.6);
    }

    return Container(
      margin: const EdgeInsets.symmetric(vertical: 1),
      padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 3),
      decoration: BoxDecoration(
        color: isHighlight
            ? Colors.green.withValues(alpha: 0.08)
            : isWarning
            ? Colors.red.withValues(alpha: 0.08)
            : Colors.transparent,
        borderRadius: BorderRadius.circular(6),
      ),
      child: Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          Icon(
            icon,
            size: 11,
            color: getColor(),
          ),
          const SizedBox(width: 5),
          Text(
            '$label: ',
            style: TextStyle(
              fontSize: 9,
              fontWeight: FontWeight.w500,
              color: Theme.of(context).colorScheme.onSurface.withValues(alpha: 0.7),
            ),
          ),
          Flexible(
            child: Text(
              value,
              style: TextStyle(
                fontSize: 9,
                fontWeight: FontWeight.w600,
                color: getColor(),
                letterSpacing: 0.2,
              ),
              overflow: TextOverflow.ellipsis,
            ),
          ),
        ],
      ),
    );
  }

  String _formatUpdateTime(DateTime dateTime) {
    // 15Î∂Ñ ÏóÖÎç∞Ïù¥Ìä∏ Ï£ºÍ∏∞Ïóê ÎßûÏ∂ò ÏãúÍ∞Ñ ÌëúÏãú
    final koreanTime = dateTime.toUtc().add(const Duration(hours: 9));
    
    return '${koreanTime.year}.${koreanTime.month.toString().padLeft(2, '0')}.${koreanTime.day.toString().padLeft(2, '0')} '
        '${koreanTime.hour.toString().padLeft(2, '0')}:${koreanTime.minute.toString().padLeft(2, '0')}';
  }

  /// ÏãúÍ∞ÄÏ¥ùÏï° Ìè¨Îß∑ÌåÖ
  String _formatMarketCap(double marketCapUsd, [double usdToKrw = 1400]) {
    final marketCapKrw = marketCapUsd * usdToKrw;
    if (marketCapKrw >= 1e12) {
      final trillions = (marketCapKrw / 1e12).toStringAsFixed(0);
      return '${_addCommas(trillions)}Ï°∞Ïõê';
    }
    if (marketCapKrw >= 1e8) {
      final hundreds = (marketCapKrw / 1e8).toStringAsFixed(0);
      return '${_addCommas(hundreds)}ÏñµÏõê';
    }
    return '${(marketCapKrw / 1e8).toStringAsFixed(1)}ÏñµÏõê';
  }

  /// Ïà´Ïûê ÏΩ§Îßà Ï∂îÍ∞Ä
  String _addCommas(String numberStr) {
    final parts = numberStr.split('.');
    final integerPart = parts[0];
    final reversedInteger = integerPart.split('').reversed.join('');
    final withCommas = reversedInteger
        .replaceAllMapped(RegExp(r'.{3}'), (match) => '${match.group(0)},')
        .split('')
        .reversed
        .join('');
    final result = withCommas.startsWith(',') ? withCommas.substring(1) : withCommas;
    return parts.length > 1 ? '$result.${parts[1]}' : result;
  }
}